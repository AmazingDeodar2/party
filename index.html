<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ´¾å¯¹æ—¶é—´ï¼</title>
  <script src="./gameData.js"></script>
  <style>
    :root {
      --bg: #0f1220;
      --panel: #181c30;
      --panel-2: #202641;
      --text: #e9ecf6;
      --muted: #aeb6d3;
      --accent: #8fb7ff;
      --danger: #ff8f8f;
      --ok: #8fe0a3;
      --border: #2b3357;
      --gold: #ffd98f;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
      background: radial-gradient(circle at top, #151a2f, #0c0f1b 60%);
      color: var(--text);
      line-height: 1.55;
    }

    .hidden { display: none !important; }

    /* æç¤ºé¢æ¿ï¼ˆç”¨äºä¸»çº¿hintã€æ”¯çº¿æç¤ºé¡µï¼‰ */
    .hint-panel {
      margin-top: 14px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(15, 18, 32, 0.72);
      padding: 12px;
    }

    .hint-head {
      display: grid;
      grid-template-columns: 300px minmax(0, 1fr);
      gap: 12px;
      align-items: start;
      margin-bottom: 0;
    }

    .hint-body {
      min-width: 0;
      display: grid;
      gap: 8px;
      align-content: start;
    }

    .hint-headerline {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 2px 0 4px;
    }

    .hint-badge {
      font-size: 11px;
      color: var(--muted);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 2px 8px;
      background: rgba(255,255,255,.02);
      white-space: nowrap;
    }

    .hint-avatar {
      width: 300px;
      height: 300px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #111528;
      overflow: hidden;
      box-shadow: 0 8px 20px rgba(0,0,0,.24);
      position: relative;
    }

    .hint-avatar::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      pointer-events: none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }

    .hint-avatar img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      object-position: center center;
      display: block;
      background: #0e1222;
    }

    .hint-avatar.fallback {
      display: grid;
      place-items: center;
      font-weight: 700;
      color: var(--muted);
      font-size: 40px;
    }

    .hint-title {
      font-weight: 700;
      color: var(--gold);
      font-size: 15px;
    }

    .hint-text {
      color: #dbe6ff;
      white-space: pre-line;
      line-height: 1.6;
    }

    .assistant-section {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed rgba(255,255,255,.08);
    }
    .assistant-section:first-of-type {
      margin-top: 0;
      padding-top: 0;
      border-top: none;
    }

    .assistant-section-title {
      font-size: 13px;
      font-weight: 700;
      color: #dbe6ff;
    }

    .branch-hint-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 8px;
      margin-top: 8px;
    }

    .branch-hint-btn {
      width: 100%;
      min-height: 40px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--panel-2);
      color: var(--text);
      font: inherit;
      font-size: 13px;
      line-height: 1.25;
      text-align: center;
      cursor: pointer;
      transition: 120ms ease;
    }

    .branch-hint-btn:hover {
      transform: translateY(-1px);
      border-color: var(--accent);
    }

    .branch-hint-btn.active {
      border-color: rgba(255,217,143,.55);
      color: var(--gold);
      box-shadow: 0 0 0 2px rgba(255,217,143,.10);
    }

    .shell {
      max-width: 1280px;
      margin: 0 auto;
      padding: 16px;
    }

    .panel {
      background: rgba(24, 28, 48, 0.96);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
    }

    .card {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      background: rgba(15, 18, 32, 0.65);
    }

    .scene-photo-wrap {
      margin-top: 10px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #111528;
      padding: 10px;
      display: flex;
      justify-content: center;
    }

    .scene-photo {
      display: block;
      width: auto;
      height: auto;
      max-width: min(100%, 420px);
      max-height: 420px;
      object-fit: contain;
      background: #0e1222;
      border-radius: 8px;
    }

    h1, h2, h3 { margin: 0 0 10px; }
    h1 { font-size: 28px; }
    h2 { font-size: 18px; }
    h3 { font-size: 16px; color: var(--accent); }

    .muted { color: var(--muted); font-size: 13px; }
    .small { font-size: 12px; color: var(--muted); }
    .preline { white-space: pre-line; }

    button {
      border-radius: 10px;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px 14px;
      cursor: pointer;
      background: var(--panel-2);
      transition: 120ms ease;
      font: inherit;
    }
    button:hover:not(:disabled) { transform: translateY(-1px); }
    button:disabled { opacity: 0.55; cursor: default; }
    button.primary { border-color: rgba(255,143,143,.45); }
    button.secondary { border-color: rgba(143,224,163,.45); }
    button.gold { border-color: rgba(255,217,143,.55); color: var(--gold); }
    button.ghost { color: var(--muted); }

    .choices {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    /* å¼€å§‹é¡µ */
    .hero {
      min-height: calc(100vh - 32px);
      display: grid;
      place-items: center;
    }
    .hero-box {
      width: min(780px, 100%);
      text-align: center;
      padding: 24px;
      border-radius: 18px;
      background: rgba(24, 28, 48, 0.96);
      border: 1px solid var(--border);
      box-shadow: 0 12px 30px rgba(0,0,0,.28);
    }
    .hero-sub {
      color: var(--muted);
      margin-top: 4px;
      margin-bottom: 16px;
    }
    .hero-quote {
      margin: 14px auto 0;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(15,18,32,.6);
      color: #dbe6ff;
      max-width: 620px;
    }

    .top-nav {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    /* æ¸¸æˆé¡µå¸ƒå±€ */
    .app {
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 16px;
    }

    .sidebar {
      display: grid;
      gap: 12px;
      align-content: start;
      position: sticky;
      top: 12px;
      height: fit-content;
    }

    .events-list {
      margin: 0;
      padding-left: 18px;
    }
    .events-list li { margin-bottom: 6px; }

    .suspect-grid {
      display: grid;
      gap: 8px;
      max-height: 500px;
      overflow: auto;
      padding-right: 4px;
    }

    .suspect-btn {
      width: 100%;
      text-align: left;
      border: 1px solid var(--border);
      background: var(--panel-2);
      color: var(--text);
      border-radius: 12px;
      padding: 10px;
      cursor: pointer;
      transition: 120ms ease;
    }
    .suspect-btn:hover:not(:disabled) {
      border-color: var(--accent);
      transform: translateY(-1px);
    }
    .suspect-btn.active {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(143,183,255,.12);
    }
    .suspect-btn.locked {
      opacity: 0.96;
      background: #1a1f36;
    }

    .suspect-head {
      display: grid;
      grid-template-columns: 40px 1fr;
      gap: 10px;
      align-items: center;
    }

    /* å°åœ†å¤´åƒï¼ˆä¾§è¾¹æ  / ç»“å±€è®°å½•ï¼‰ */
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: #111528;
      display: grid;
      place-items: center;
      font-size: 20px;
      line-height: 1;
      user-select: none;
      flex: 0 0 auto;
      overflow: hidden;
    }
    .avatar.big {
      width: 54px;
      height: 54px;
      font-size: 26px;
    }
    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center 28%;
      border-radius: 50%;
      display: block;
    }

    /* ç«–å¡ç«‹ç»˜ï¼ˆä¸»èˆå°ç”¨ï¼‰ */
    .avatar-portrait {
      width: 92px;
      height: 124px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #111528;
      overflow: hidden;
      display: grid;
      place-items: center;
      flex: 0 0 auto;
      position: relative;
      box-shadow: 0 6px 14px rgba(0,0,0,.22);
    }
    .avatar-portrait::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      pointer-events: none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .avatar-portrait img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center 20%;
      display: block;
    }
    .avatar-portrait.big {
      width: 118px;
      height: 158px;
      border-radius: 14px;
    }
    .avatar-portrait.fallback {
      color: var(--muted);
      font-size: 28px;
      font-weight: 700;
    }

    .suspect-name {
      font-weight: 700;
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }

    .badge {
      font-size: 11px;
      color: #d8def8;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 1px 7px;
      background: #141a2f;
    }

    .status-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    .tag {
      display: inline-block;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 12px;
      border: 1px solid var(--border);
      color: var(--muted);
      background: #14182b;
    }
    .tag.guilty { border-color: rgba(255,143,143,.45); color: var(--danger); }
    .tag.innocent { border-color: rgba(143,224,163,.45); color: var(--ok); }
    .tag.gold { border-color: rgba(255,217,143,.45); color: var(--gold); }

    .main {
      display: grid;
      gap: 12px;
      align-content: start;
    }

    .stage { min-height: 340px; }

    .tab-strip {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .hero-line {
      border-left: 3px solid var(--accent);
      padding: 8px 10px;
      margin-top: 10px;
      background: rgba(143,183,255,.06);
      border-radius: 8px;
      color: #dbe6ff;
    }

    .reaction-box {
      margin-top: 12px;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #13172a;
    }

    .result-panel {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      background: rgba(20, 24, 42, 0.92);
    }

    .judge-record {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 8px;
      margin-top: 10px;
    }

    .record-item {
      border: 1px solid var(--border);
      background: #121628;
      border-radius: 10px;
      padding: 8px;
      font-size: 13px;
    }

    /* æˆå°±é¡µ */
    .achievement-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 10px;
      margin-top: 12px;
    }

    .achievement-item {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(15,18,32,.6);
      padding: 12px;
    }
    .achievement-item.unlocked {
      border-color: rgba(255,217,143,.45);
      box-shadow: inset 0 0 0 1px rgba(255,217,143,.12);
    }

    .achievement-icon {
      font-size: 20px;
      margin-right: 6px;
    }

    /* å°å± */
    @media (max-width: 980px) {
      .hint-head {
        grid-template-columns: 1fr;
      }

      .hint-avatar {
        width: min(100%, 300px);
        height: min(100vw - 80px, 300px);
        margin: 0 auto;
      }

      .branch-hint-list {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .hint-headerline {
        flex-direction: column;
        align-items: flex-start;
      }

      .app { grid-template-columns: 1fr; }
      .sidebar { position: static; }
      .hero { min-height: auto; padding-top: 40px; }
    }
  </style>
</head>
<body>
  <div class="shell">

    <!-- å¼€å§‹é¡µé¢ -->
    <section id="screen-start" class="hero">
      <div class="hero-box">
        <h1 id="start-title">æ´¾å¯¹æ—¶é—´ï¼</h1>
        <div class="hero-sub">çœŸçš„æ˜¯æ´¾å¯¹å—ï¼Ÿ</div>

        <div class="hero-quote preline" id="start-quote"></div>

        <div class="choices" style="justify-content:center; margin-top:18px;">
          <button class="gold" id="btn-start-game">å¼€å§‹è°ƒæŸ¥</button>
          <button id="btn-go-achievements">æˆå°±ç•Œé¢</button>
          <button id="btn-go-branch-hints">æ”¯çº¿æç¤º</button>
        </div>
      </div>
    </section>

    <!-- æˆå°±é¡µé¢ -->
    <section id="screen-achievements" class="hidden">
      <div class="top-nav">
        <h2 style="margin:0;">æˆå°±ç•Œé¢</h2>
        <div class="choices" style="margin-top:0;">
          <button class="ghost" id="btn-ach-back-start">è¿”å›å¼€å§‹é¡µé¢</button>
          <button class="ghost" id="btn-ach-reset">é‡ç½®æˆå°±è®°å½•</button>
        </div>
      </div>

      <div class="panel">
        <div class="muted" id="achievement-summary">å·²è§£é” 0 / 10 ç§ç»“å±€</div>
        <div class="achievement-grid" id="achievement-grid"></div>
      </div>
    </section>

    <!-- æ”¯çº¿æç¤ºé¡µé¢ -->
    <section id="screen-branch-hints" class="hidden">
      <div class="top-nav">
        <h2 style="margin:0;">æ”¯çº¿æç¤º</h2>
        <div class="choices" style="margin-top:0;">
          <button class="ghost" id="btn-branch-back-start">è¿”å›å¼€å§‹é¡µé¢</button>
        </div>
      </div>

      <div class="panel">
        <div id="branch-hints-content"></div>
      </div>
    </section>

    <!-- æ¸¸æˆé¡µé¢ -->
    <section id="screen-game" class="hidden">
      <div class="top-nav">
        <div>
          <h2 id="game-title" style="margin:0;"></h2>
          <div class="muted"></div>
        </div>
        <div class="choices" style="margin-top:0;">
          <button class="ghost" id="btn-game-back-start">è¿”å›å¼€å§‹é¡µé¢</button>
          <button class="ghost" id="btn-restart">é‡å¼€æœ¬è½®</button>
        </div>
      </div>

      <div class="app">
        <aside class="sidebar">
          <section class="panel">
            <h2>å¤šå°‘æœ‰ç‚¹å¤ªä¹±äº†å§ï¼</h2>
            <ol class="events-list" id="events-list"></ol>
          </section>

          <section class="panel">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
              <h2 style="margin:0;">åœ¨åœºäººç‰©</h2>
              <div class="muted" id="progress-text">0 / 9 å·²é”å®š</div>
            </div>
            <div class="suspect-grid" id="suspect-grid"></div>
          </section>
        </aside>

        <main class="main">
          <section class="panel stage" id="stage-panel">
            <div class="tab-strip">
              <button class="ghost" id="tab-stage-investigation">è°ƒæŸ¥è§†å›¾</button>
              <button class="ghost" id="tab-stage-scene">åœºæ™¯æ€»è§ˆ</button>
            </div>
            <div id="stage-content"></div>
          </section>

          <section class="panel hidden" id="ending-panel">
            <div class="result-panel">
              <div class="tab-strip">
                <button class="ghost" id="tab-ending">ç»“å±€</button>
                <button class="gold hidden" id="tab-recap">çœŸç›¸å¤ç›˜ï¼ˆè§£é”ï¼‰</button>
              </div>

              <div id="ending-view">
                <h2 id="ending-title"></h2>
                <div class="preline" id="ending-text"></div>

                <h3 style="margin-top:14px;">ä½ çš„è£å®šè®°å½•</h3>
                <div class="judge-record" id="judge-record"></div>

                <div class="choices" style="margin-top:14px;">
                  <button class="ghost" id="btn-restart-from-end">å†æ¥ä¸€è½®</button>
                  <button id="btn-ending-go-achievements">æŸ¥çœ‹æˆå°±</button>
                </div>
              </div>

              <div id="recap-view" class="hidden">
                <h2 id="recap-title"></h2>
                <div class="preline" id="recap-text"></div>

                <div class="choices" style="margin-top:14px;">
                  <button class="ghost" id="btn-restart-from-recap">å†æ¥ä¸€è½®</button>
                  <button id="btn-recap-go-achievements">æŸ¥çœ‹æˆå°±</button>
                </div>
              </div>
            </div>
          </section>
        </main>
      </div>
    </section>
  </div>

  <script>
    // ===== ç»“å±€æˆå°±é…ç½® =====
    const ENDING_META = {
      good_end: {
        name: "å®Œç¾ç»“å±€",
        icon: "ğŸ‰",
        desc: "ä¹äººç»“æœå…¨éƒ¨å¯¹ä¸Šï¼Œæ´¾å¯¹è™½ç„¶æ™šç‚¹ï¼Œä½†ç»ˆäºæ­£å¸¸å¼€åœºã€‚"
      },
      handler_blame: {
        name: "å®Œç¾é”™ä½",
        icon: "ğŸª",
        desc: "ä½ çš„ç»“æœå’Œç°åœºå®é™…æƒ…å†µæ•´æ•´é½é½é”™å¼€ã€‚"
      },
      mixed: {
        name: "å‹‰å¼ºå¼€åœº",
        icon: "ğŸ§¹",
        desc: "æœ‰å¯¹æœ‰é”™ï¼Œç°åœºåœ¨äº’ç›¸åæ§½ä¸­å‹‰å¼ºæ¢å¤ã€‚"
      },
      too_kind: {
        name: "éƒ½æŒºä¸å®¹æ˜“",
        icon: "ğŸ™‚",
        desc: "è°éƒ½ä¸å¾€åå•é‡Œæ”¾ï¼Œç»“æœä¹Ÿæ²¡äººå…ˆåŠ¨æ‰‹æ”¶æ‹¾ã€‚"
      },
            label_judge: {
        name: "ä¸€é”…ç«¯",
        icon: "âš–ï¸",
        desc: "ä¹ä¸ªäººå…¨è¿›åå•ï¼Œæ´¾å¯¹åŸåœ°å‡çº§æˆé›†ä½“ç”³è¯‰ä¼šã€‚"
      },
      conspiracy: {
        name: "ä¼Šå¾·æµ·æ‹‰å…¥ä¾µé¢„æ¡ˆ",
        icon: "ğŸŒ€",
        desc: "ç‰¹å®šç»„åˆè§¦å‘å¼‚å¸¸äº‹ä»¶ï¼Œç†Ÿäººå±€äº‹æ•…çªç„¶å‡çº§ã€‚"
      },
      fff_club: {
        name: "FFFå›¢",
        icon: "ğŸ”¥",
        desc: "ä½ ç‚¹å‡ºäº†æŸä¸ªå¾®å¦™å››äººç»„ï¼Œç°åœºæ°”æ°›è¿…é€Ÿè½¬å…¥ç†Ÿäººå±€å…«å¦é¢‘é“ã€‚"
      },
      best_partner: {
        name: "æœ€ä½³æ‹æ¡£",
        icon: "ğŸ¬",
        desc: "ä½ çœ‹å‡ºäº†ä¸¤äººçš„é…åˆé»˜å¥‘ï¼Œåæ¥å¥¹ä»¬çœŸæŠŠè¿™ä»½é»˜å¥‘æ‹è¿›äº†ç”µå½±é‡Œã€‚"
      },
      dorm_headache: {
        name: "å¯å®¤é•¿çš„å™©æ¢¦",
        icon: "ğŸ›ï¸",
        desc: "è¿™ä»½åå•ç²¾å‡†å”¤é†’äº†æŸäººç®¡ç†ç”·ç”Ÿå®¿èˆçš„æ—§æ—¥åˆ›ä¼¤ã€‚"
      },
        clear_eyes: {
        name: "æ¸…æ¾ˆçš„çœ¼ç¥",
        icon: "ğŸ‘€",
        desc: "ä½ æŒ‡è®¤äº†å››ä½æ›´â€œæ²‰å¾—ä½æ°”â€çš„äººï¼Œæ”¾èµ°çš„é‚£å‡ ä½åè€Œæ€¥ç€æŠŠæ¯ä¸€æ­¥éƒ½è®²æ¸…æ¥šã€‚"
      },
      mouse_line: {
        name: "ä¸é€Ÿä¹‹å®¢",
        icon: "ğŸ¾",
        desc: "ä½ æŠŠæè¿‡çª¸çª£çš„äººéƒ½æ”¾è¿‡äº†ï¼Œå…¶ä½™äººå…¨è®°ä¸Šï¼›é‚£å£°å¢™æ ¹åŠ¨é™å´åœ¨å…³é”®æ—¶åˆ»å†æ¬¡å“èµ·ã€‚"
      },
      fox_slip: {
        name: "ç‹ç‹¸ä¼šæ¼å‡ºé©¬è„š",
        icon: "ğŸ¦Š",
        desc: "ä½ æŠŠæ··åœ¨äººå †é‡Œçœ‹æˆçš„é‚£ä¸ªä¸œè¥¿å…ˆæ‹äº†å‡ºæ¥ã€‚"
      }
    };

    // ===== æœ¬åœ°å­˜å‚¨ Key =====
    const ACHIEVEMENT_STORAGE_KEY = "party_disaster_ending_achievements_v1";

    // ===== å¼€å§‹é¡µéšæœºæ–‡æ¡ˆ =====
    const START_SCREEN_LINES = [
      "ä½ å¸¦ç€ç¤¼ç‰©ç«™åœ¨é—¨å£ï¼Œå·²ç»æƒ³å¥½è¿›å»å…ˆå¤¸ä¸€å¥å¸ƒç½®çœŸä¸é”™ã€‚",
      "ä½ åœ¨é—¨å¤–è¿˜å¬è§é‡Œé¢å¾ˆçƒ­é—¹â€”â€”è‡³å°‘å¬èµ·æ¥åƒæ˜¯çƒ­é—¹ã€‚",
      "æ¥ä¹‹å‰ä½ ä»¥ä¸ºä»Šæ™šçš„ä»»åŠ¡åªæœ‰åƒè›‹ç³•ï¼Œç°åœ¨çœ‹æ¥å¯èƒ½ä¸æ­¢ã€‚",
      "é—¨æŠŠæ‰‹åˆšå‹ä¸‹å»ï¼Œä½ çªç„¶æœ‰ç§ä¸å¤ªå¦™ã€ä½†åˆå¾ˆå¥½ç¬‘çš„é¢„æ„Ÿã€‚"
    ];

    // ===== èµ„æº =====
    const AVATAR_BASE_PATH = "./";
    const SCENE_IMAGE_MAP = {
      missingCakeTable: "./table.png"
    };
    const AVATAR_FILE_MAP = {
      "è±†ä»˜çš®": "doufupi.png",
      "è±†é›…è´¢": "douyacai.png",
      "è±†èåŒ…": "doushabao.png",
      "è±†æ± ": "douchi.png",
      "è±†çŸ¥å„¿": "douzhier.png",
      "è±†è›¾æ¸Š": "doueyuan.png",
      "è±†å‚å°†": "doubanjiang.png",
      "è±†ä¹ƒ": "dounai.png",
      "è±†å€ªä¸‡": "douniwan.png"
    };
    const AVATAR_CROP_MAP = {
      "è±†é›…è´¢": "80% 28%",
      "è±†æ± ": "center 60%",
      "è±†è›¾æ¸Š": "40% 28%"
    };

    // ===== çŠ¶æ€ =====
    const state = {
      screen: "start", // start | achievements | branch_hints | game
      phase: "intro",  // intro | question | reacted | ended
      selectedId: null,
      judgments: {},
      lockedIds: new Set(),
      introVariant: "",
      ending: null,
      endingTab: "ending",
      stageTab: "investigation",
      endingMainHintCache: null,  // æ™®é€šç»“å±€è‡ªåŠ¨ä¸»çº¿æç¤ºï¼ˆæœ¬è½®å›ºå®šï¼‰
      branchHintSelectedKey: null // æ”¯çº¿æç¤ºé¡µé€‰ä¸­çš„æ”¯çº¿
    };

    // ===== DOM =====
    const screenStartEl = document.getElementById("screen-start");
    const screenAchievementsEl = document.getElementById("screen-achievements");
    const screenBranchHintsEl = document.getElementById("screen-branch-hints");
    const screenGameEl = document.getElementById("screen-game");

    const startTitleEl = document.getElementById("start-title");
    const startQuoteEl = document.getElementById("start-quote");

    const btnStartGame = document.getElementById("btn-start-game");
    const btnGoAchievements = document.getElementById("btn-go-achievements");
    const btnGoBranchHints = document.getElementById("btn-go-branch-hints");

    const btnAchBackStart = document.getElementById("btn-ach-back-start");
    const btnAchReset = document.getElementById("btn-ach-reset");
    const achievementSummaryEl = document.getElementById("achievement-summary");
    const achievementGridEl = document.getElementById("achievement-grid");

    const btnBranchBackStart = document.getElementById("btn-branch-back-start");
    const branchHintsContentEl = document.getElementById("branch-hints-content");

    const gameTitleEl = document.getElementById("game-title");
    const btnGameBackStart = document.getElementById("btn-game-back-start");
    const btnRestart = document.getElementById("btn-restart");

    const eventsListEl = document.getElementById("events-list");
    const suspectGridEl = document.getElementById("suspect-grid");
    const progressTextEl = document.getElementById("progress-text");
    const stageContentEl = document.getElementById("stage-content");

    const tabStageInvestigationEl = document.getElementById("tab-stage-investigation");
    const tabStageSceneEl = document.getElementById("tab-stage-scene");

    const endingPanelEl = document.getElementById("ending-panel");
    const endingTitleEl = document.getElementById("ending-title");
    const endingTextEl = document.getElementById("ending-text");
    const judgeRecordEl = document.getElementById("judge-record");

    const tabEndingEl = document.getElementById("tab-ending");
    const tabRecapEl = document.getElementById("tab-recap");
    const endingViewEl = document.getElementById("ending-view");
    const recapViewEl = document.getElementById("recap-view");
    const recapTitleEl = document.getElementById("recap-title");
    const recapTextEl = document.getElementById("recap-text");

    const btnRestartFromEnd = document.getElementById("btn-restart-from-end");
    const btnRestartFromRecap = document.getElementById("btn-restart-from-recap");
    const btnEndingGoAchievements = document.getElementById("btn-ending-go-achievements");
    const btnRecapGoAchievements = document.getElementById("btn-recap-go-achievements");

    // ===== å·¥å…·å‡½æ•° =====
    function pickRandom(arr) {
      if (!Array.isArray(arr) || arr.length === 0) return null;
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    function nl2br(str) {
      return escapeHtml(str).replace(/\n/g, "<br>");
    }

    function getSuspectById(id) {
      return GAME_DATA.suspects.find(s => s.id === id);
    }

    function allLocked() {
      return state.lockedIds.size === GAME_DATA.suspects.length;
    }

    function getWrongSuspectIdsForCurrentRun() {
      const wrong = [];
      for (const s of GAME_DATA.suspects) {
        if (!(s.id in state.judgments)) continue;
        const judged = !!state.judgments[s.id];
        const truth = !!s.isCulprit;
        if (judged !== truth) wrong.push(s.id);
      }
      return wrong;
    }

    function buildMainlineHintForMixedEnding() {
      if (!state.ending || state.ending.key !== "mixed") return null;

      const wrongIds = getWrongSuspectIdsForCurrentRun();
      if (wrongIds.length === 0) return null;

      const pickedId = pickRandom(wrongIds);
      const suspect = getSuspectById(pickedId);
      const hintList = GAME_DATA.mainlineHintsBySuspect?.[pickedId] || [];
      const hintText = pickRandom(hintList);

      if (!hintText) return null;

      return {
        suspectId: pickedId,
        suspectName: suspect?.name || pickedId,
        text: hintText
      };
    }

    function getAvatar(s) {
      const fileName = AVATAR_FILE_MAP[s.name];
      if (fileName) return AVATAR_BASE_PATH + fileName;
      return null;
    }

    function getAvatarFallbackText(s) {
      return s.avatar || s.name?.[0] || "ğŸ™‚";
    }

    function getAvatarHtml(s, extraClass = "") {
      const src = getAvatar(s);
      const fallback = escapeHtml(getAvatarFallbackText(s));
      const cls = extraClass ? `avatar ${extraClass}` : "avatar";
      const crop = AVATAR_CROP_MAP[s.name] || "center 28%";

      if (src) {
        return `
          <div class="${cls}" aria-hidden="true">
            <img src="${escapeHtml(src)}" alt="${escapeHtml(s.name)}å¤´åƒ"
                 style="object-position:${escapeHtml(crop)};"
                 onerror="this.remove(); this.parentElement.textContent='${fallback}';" />
          </div>
        `;
      }

      return `<div class="${cls}" aria-hidden="true">${fallback}</div>`;
    }

    function getPortraitAvatarHtml(s, extraClass = "") {
      const src = getAvatar(s);
      const fallback = escapeHtml(getAvatarFallbackText(s));
      const cls = extraClass ? `avatar-portrait ${extraClass}` : "avatar-portrait";

      if (src) {
        return `
          <div class="${cls}" aria-hidden="true">
            <img src="${escapeHtml(src)}" alt="${escapeHtml(s.name)}ç«‹ç»˜"
                 onerror="this.remove(); this.parentElement.classList.add('fallback'); this.parentElement.textContent='${fallback}';" />
          </div>
        `;
      }

      return `<div class="${cls} fallback" aria-hidden="true">${fallback}</div>`;
    }

    // ===== ä¸»çº¿hintï¼ˆä»…æ™®é€šç»“å±€æ˜¾ç¤ºï¼Œæ”¾åœ¨ç»“å±€æ–‡å­—ä¸‹ï¼‰=====
    function renderMainlineHintBox() {
      if (!state.ending || state.ending.key !== "mixed") return "";

      const payload = state.endingMainHintCache;
      if (!payload) return "";

      return `
        <div class="hint-panel">
          <div class="assistant-section">
            <div class="assistant-section-title">æœ¬è½®æç¤º</div>
            <div class="small" style="margin-top:2px;">è¿™è½®å¯ä»¥å›å¤´ç•™æ„ï¼š${escapeHtml(payload.suspectName)}</div>
            <div class="hint-text" style="margin-top:8px;">${nl2br(payload.text || "")}</div>
          </div>
        </div>
      `;
    }

    // ===== æ”¯çº¿æç¤ºé¡µ =====
    function renderBranchHintPage() {
      const assistant = GAME_DATA.hintAssistant || {};
      const assistantName = assistant.name || "é¹…ä¾¦æ¢";
      const assistantAvatar = assistant.avatar ? `./${assistant.avatar}` : "";

      const branchHints = GAME_DATA.assistantBranchHints || {};
      const entries = Object.entries(branchHints);

      if (!entries.length) {
        branchHintsContentEl.innerHTML = `
          <div class="card">
            <h3>æ”¯çº¿æç¤º</h3>
            <div class="muted">å½“å‰æ²¡æœ‰å¯ç”¨çš„æ”¯çº¿æç¤ºã€‚</div>
          </div>
        `;
        return;
      }

      if (!state.branchHintSelectedKey || !branchHints[state.branchHintSelectedKey]) {
        state.branchHintSelectedKey = entries[0][0];
      }

      const selected = branchHints[state.branchHintSelectedKey];

      const avatarHtml = assistantAvatar
        ? `
          <div class="hint-avatar" aria-hidden="true">
            <img src="${escapeHtml(assistantAvatar)}" alt="${escapeHtml(assistantName)}"
                 onerror="this.remove(); this.parentElement.classList.add('fallback'); this.parentElement.textContent='E';" />
          </div>
        `
        : `<div class="hint-avatar fallback" aria-hidden="true">E</div>`;

      const buttonsHtml = entries.map(([key, item]) => `
        <button
          type="button"
          class="branch-hint-btn ${state.branchHintSelectedKey === key ? "active" : ""}"
          data-branch-key="${escapeHtml(key)}"
        >
          ${escapeHtml(item.name)}
        </button>
      `).join("");

      branchHintsContentEl.innerHTML = `
        <div class="hint-panel" style="margin-top:0;">
          <div class="hint-head">
            ${avatarHtml}
            <div class="hint-body">
              <div class="hint-headerline">
                <div class="hint-title">${escapeHtml(assistantName)} Â· æ”¯çº¿æç¤º</div>
                <div class="hint-badge"></div>
              </div>

              <div class="assistant-section">
                <div class="assistant-section-title">é€‰æ‹©æ”¯çº¿</div>
                <div class="branch-hint-list">
                  ${buttonsHtml}
                </div>
              </div>

              <div class="assistant-section">
                <div class="assistant-section-title">${escapeHtml(selected?.name || "æç¤º")}</div>
                <div class="hint-text" style="margin-top:8px;">${nl2br(selected?.hint || "")}</div>
              </div>
            </div>
          </div>
        </div>
      `;

      bindBranchHintPageEvents();
    }

    function bindBranchHintPageEvents() {
      document.querySelectorAll(".branch-hint-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const key = btn.dataset.branchKey;
          if (!key) return;
          state.branchHintSelectedKey = key;
          renderBranchHintPage();
        });
      });
    }

    // ===== æˆå°±å­˜å‚¨ =====
    function loadAchievements() {
      try {
        const raw = localStorage.getItem(ACHIEVEMENT_STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch {
        return [];
      }
    }

    function saveAchievements(keys) {
      localStorage.setItem(ACHIEVEMENT_STORAGE_KEY, JSON.stringify([...new Set(keys)]));
    }

    function unlockEndingAchievement(endingKey) {
      if (!endingKey) return;
      const current = loadAchievements();
      if (!current.includes(endingKey)) {
        current.push(endingKey);
        saveAchievements(current);
      }
    }

    function resetAchievements() {
      localStorage.removeItem(ACHIEVEMENT_STORAGE_KEY);
    }

    // ===== é¡µé¢åˆ‡æ¢ =====
    function setScreen(screen) {
      state.screen = screen;

      screenStartEl.classList.toggle("hidden", screen !== "start");
      screenAchievementsEl.classList.toggle("hidden", screen !== "achievements");
      screenBranchHintsEl.classList.toggle("hidden", screen !== "branch_hints");
      screenGameEl.classList.toggle("hidden", screen !== "game");

      if (screen === "start") renderStartScreen();
      if (screen === "achievements") renderAchievementsScreen();
      if (screen === "branch_hints") renderBranchHintPage();
      if (screen === "game") renderGameScreen();
    }

    // ===== å¼€å§‹é¡µ =====
    function renderStartScreen() {
      startTitleEl.textContent = GAME_DATA.title || "æ´¾å¯¹æ—¶é—´ï¼";
      const line = START_SCREEN_LINES[Math.floor(Math.random() * START_SCREEN_LINES.length)];
      startQuoteEl.innerHTML = nl2br(
        "ä½ æ”¶åˆ°ä¸€å¼ è±†å®¶äººçš„æ´¾å¯¹é‚€è¯·ã€‚\næŒ‰é‚€è¯·å‡½ä¸Šçš„è¯´æ³•ï¼Œä»Šæ™šä¼šæ˜¯ä¸€åœºâ€œç»å¯¹ä¸ä¼šå‡ºæ„å¤–â€çš„å®Œç¾èšä¼šã€‚\n" + line
      );
    }

    // ===== æˆå°±é¡µ =====
    function renderAchievementsScreen() {
      const unlocked = new Set(loadAchievements());
      const entries = Object.entries(ENDING_META);

      achievementSummaryEl.textContent = `å·²è§£é” ${unlocked.size} / ${entries.length} ç§ç»“å±€`;

      achievementGridEl.innerHTML = "";
      entries.forEach(([key, meta]) => {
        const isUnlocked = unlocked.has(key);
        const item = document.createElement("div");
        item.className = "achievement-item" + (isUnlocked ? " unlocked" : "");
        item.innerHTML = `
          <div style="display:flex;align-items:center;gap:6px;">
            <span class="achievement-icon">${isUnlocked ? meta.icon : "â”"}</span>
            <div style="font-weight:700;">${escapeHtml(meta.name)}</div>
          </div>
          <div class="small" style="margin-top:8px;">
            ${escapeHtml(isUnlocked ? meta.desc : "å°šæœªè§£é”ã€‚ç»§ç»­å°è¯•ä¸åŒçš„é€‰æ‹©ç»„åˆã€‚")}
          </div>
          <div style="margin-top:8px;">
            <span class="tag ${isUnlocked ? "gold" : ""}">${isUnlocked ? "å·²è§£é”" : "æœªè§£é”"}</span>
          </div>
        `;
        achievementGridEl.appendChild(item);
      });
    }

    // ===== æ¸¸æˆé‡ç½®ï¼ˆå•å±€ï¼‰=====
    function resetGameRun() {
      state.phase = "intro";
      state.selectedId = null;
      state.judgments = {};
      state.lockedIds = new Set();
      state.introVariant = typeof GAME_DATA.getRandomIntroLine === "function"
        ? GAME_DATA.getRandomIntroLine()
        : "";
      state.ending = null;
      state.endingTab = "ending";
      state.stageTab = "investigation";
      state.endingMainHintCache = null;
      // state.branchHintSelectedKey ä¸é‡ç½®ï¼šæ”¯çº¿æç¤ºé¡µä¿ç•™ç”¨æˆ·ä¸Šæ¬¡é€‰æ‹©
      endingPanelEl.classList.add("hidden");
      renderGameScreen();
    }

    // ===== æ¸¸æˆé¡µæ¸²æŸ“ï¼šä¾§è¾¹æ  =====
    function renderGameSidebar() {
      gameTitleEl.textContent = GAME_DATA.title || "æ´¾å¯¹æ—¶é—´ï¼";
      progressTextEl.textContent = `${state.lockedIds.size} / ${GAME_DATA.suspects.length} å·²é”å®š`;

      eventsListEl.innerHTML = "";
      (GAME_DATA.visibleEvents || []).forEach(ev => {
        const li = document.createElement("li");
        li.textContent = ev;
        eventsListEl.appendChild(li);
      });

      suspectGridEl.innerHTML = "";
      GAME_DATA.suspects.forEach(s => {
        const isLocked = state.lockedIds.has(s.id);
        const active = state.selectedId === s.id;

        const btn = document.createElement("button");
        btn.className = `suspect-btn${isLocked ? " locked" : ""}${active ? " active" : ""}`;
        btn.innerHTML = `
          <div class="suspect-head">
            ${getAvatarHtml(s)}
            <div>
              <div class="suspect-name">
                <span>${escapeHtml(s.name)}</span>
                <span class="badge">${escapeHtml((s.role || "").split("ï¼Œ")[0] || "äººç‰©")}</span>
              </div>
              <div class="small">${escapeHtml(s.eventTitle || "")}</div>
            </div>
          </div>
          <div class="status-row" id="status-${s.id}"></div>
        `;

        btn.addEventListener("click", () => {
          if (state.phase === "ended") return;
          state.selectedId = s.id;
          state.phase = isLocked ? "reacted" : "question";
          state.stageTab = "investigation";
          renderGameScreen();
        });

        suspectGridEl.appendChild(btn);

        const statusRow = btn.querySelector(`#status-${s.id}`);
        if (isLocked) {
          const judged = state.judgments[s.id];
          statusRow.innerHTML = `
            <span class="tag ${judged ? "guilty" : "innocent"}">ä½ åˆ¤ï¼š${judged ? "æ˜¯" : "å¦"}</span>
            <span class="tag">å·²é”å®š</span>
          `;
        } else {
          statusRow.innerHTML = `<span class="tag">æœªåˆ¤å®š</span>`;
        }
      });
    }

    // ===== æ¸¸æˆé¡µæ¸²æŸ“ï¼šèˆå° =====
    function renderIntroStage() {
      stageContentEl.innerHTML = `
        <div class="card">
          <h2>å¼€åœº</h2>
          <div class="preline">${nl2br(GAME_DATA.introBase || "")}</div>
          ${state.introVariant ? `<div class="hero-line">${escapeHtml(state.introVariant)}</div>` : ""}
          <div class="preline" style="margin-top:8px;">å±‹é‡Œä¹ä¸ªäººé½åˆ·åˆ·çœ‹å‘ä½ ï¼šä½ æ¥å¾—æ­£å¥½ï¼Œå¿«åˆ¤ã€‚</div>
        </div>

        <div class="card" style="margin-top:10px;">
          <h2>ç°åœº</h2>
          <div class="preline">${nl2br(GAME_DATA.sceneDescription || "")}</div>

          <div class="scene-photo-wrap">
            <img
              class="scene-photo"
              src="${escapeHtml(SCENE_IMAGE_MAP.missingCakeTable)}"
              alt="è›‹ç³•ä¸è§äº†çš„æ¡Œå­ç°åœº"
              onerror="this.parentElement.style.display='none';"
            />
          </div>
        </div>
      `;
    }

    function renderSceneOverviewStage() {
      const currentName = state.selectedId ? getSuspectById(state.selectedId).name : "æœªé€‰æ‹©";
      const currentLocked = state.selectedId ? state.lockedIds.has(state.selectedId) : false;

      stageContentEl.innerHTML = `
        <div class="card">
          <h2>åœºæ™¯æ€»è§ˆ</h2>
          <div class="preline">${nl2br(GAME_DATA.sceneDescription || "")}</div>

          <div class="scene-photo-wrap">
            <img
              class="scene-photo"
              src="${escapeHtml(SCENE_IMAGE_MAP.missingCakeTable)}"
              alt="è›‹ç³•ä¸è§äº†çš„æ¡Œå­ç°åœº"
              onerror="this.parentElement.style.display='none';"
            />
          </div>
        </div>

        <div class="card" style="margin-top:10px;">
          <h2>å½“å‰ç„¦ç‚¹</h2>
          <div class="muted">äººç‰©ï¼š${escapeHtml(currentName)} ${state.selectedId ? `ï¼ˆ${currentLocked ? "å·²é”å®š" : "æœªé”å®š"}ï¼‰` : ""}</div>
          <div class="muted" style="margin-top:4px;">è¿›åº¦ï¼š${state.lockedIds.size} / ${GAME_DATA.suspects.length}</div>
        </div>
      `;
    }

    function renderQuestionStage(s) {
      stageContentEl.innerHTML = `
        <div class="card">
          <div style="display:grid;grid-template-columns:118px 1fr;gap:12px;align-items:start;">
            ${getPortraitAvatarHtml(s, "big")}
            <div>
              <h2 style="margin:0;">${escapeHtml(s.name)}</h2>
              <div class="muted">${escapeHtml(s.role || "")}</div>
              <div class="small" style="margin-top:4px;">${escapeHtml(s.eventTitle || "")}</div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:10px;">
          <div class="preline">${nl2br(s.questionText || "")}</div>

          <div class="choices">
            <button class="primary" id="judge-guilty">åˆ¤å®šï¼šæ˜¯å‡¶æ‰‹</button>
            <button class="secondary" id="judge-innocent">åˆ¤å®šï¼šä¸æ˜¯å‡¶æ‰‹</button>
          </div>
        </div>
      `;

      document.getElementById("judge-guilty").addEventListener("click", () => applyJudgment(s.id, true));
      document.getElementById("judge-innocent").addEventListener("click", () => applyJudgment(s.id, false));
    }

    function renderLockedStage(s) {
      const judged = state.judgments[s.id];
      const reactionText = judged ? s.reactions.guilty : s.reactions.innocent;

      stageContentEl.innerHTML = `
        <div class="card">
          <div style="display:grid;grid-template-columns:118px 1fr;gap:12px;align-items:start;">
            ${getPortraitAvatarHtml(s, "big")}
            <div>
              <h2 style="margin:0;">${escapeHtml(s.name)}</h2>
              <div class="muted">${escapeHtml(s.role || "")}</div>
              <div class="small" style="margin-top:4px;">å¯¹åº”äº‹ä»¶ï¼š${escapeHtml(s.eventTitle || "")}</div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:10px;">
          <div class="status-row">
            <span class="tag ${judged ? "guilty" : "innocent"}">ä½ åˆ¤ï¼š${judged ? "æ˜¯å‡¶æ‰‹" : "ä¸æ˜¯å‡¶æ‰‹"}</span>
            <span class="tag">å·²é”å®š</span>
          </div>

          <div class="reaction-box preline">${nl2br(reactionText || "")}</div>
        </div>
      `;
    }

    function renderNoSelectionStage() {
      stageContentEl.innerHTML = `
        <div class="card">
          <h2>ç°åœº</h2>
          <div class="muted">ä»å·¦ä¾§é€‰æ‹©ä¸€ååœ¨åœºäººç‰©ã€‚</div>
        </div>
      `;
    }

    function setStageTab(tab) {
      state.stageTab = tab;
      renderGameScreen();
    }

    function renderStage() {
      tabStageInvestigationEl.classList.toggle("gold", state.stageTab === "investigation");
      tabStageSceneEl.classList.toggle("gold", state.stageTab === "scene");

      if (state.stageTab === "scene") {
        renderSceneOverviewStage();
        return;
      }

      if (state.phase === "intro" && !state.selectedId) {
        renderIntroStage();
        return;
      }

      if (!state.selectedId) {
        renderNoSelectionStage();
        return;
      }

      const s = getSuspectById(state.selectedId);
      const isLocked = state.lockedIds.has(s.id);

      if (isLocked) renderLockedStage(s);
      else renderQuestionStage(s);
    }

    // ===== ç»“å±€åŒº =====
    function setEndingTab(tab, canShowRecap = false) {
      if (tab === "recap" && !canShowRecap) tab = "ending";
      state.endingTab = tab;

      const showRecap = tab === "recap" && canShowRecap;
      endingViewEl.classList.toggle("hidden", showRecap);
      recapViewEl.classList.toggle("hidden", !showRecap);

      tabEndingEl.classList.toggle("gold", !showRecap);
      tabRecapEl.classList.toggle("gold", showRecap);
    }

    function renderEndingPanel() {
      if (!state.ending) return;

      endingTitleEl.textContent = state.ending.title || "ç»“å±€";

      // åªä¿ç•™ä¸»çº¿hintï¼ˆæ™®é€šç»“å±€ï¼‰
      endingTextEl.innerHTML =
        nl2br(state.ending.text || "") +
        renderMainlineHintBox();

      judgeRecordEl.innerHTML = "";
      GAME_DATA.suspects.forEach(s => {
        const judged = state.judgments[s.id];
        const item = document.createElement("div");
        item.className = "record-item";
        item.innerHTML = `
          <div style="display:flex;gap:8px;align-items:center;">
            ${getAvatarHtml(s)}
            <div>
              <div style="font-weight:700;">${escapeHtml(s.name)}</div>
              <div class="small">${escapeHtml(s.eventTitle || "")}</div>
            </div>
          </div>
          <div style="margin-top:8px;">
            <span class="tag ${judged ? "guilty" : "innocent"}">ä½ åˆ¤ï¼š${judged ? "æ˜¯å‡¶æ‰‹" : "ä¸æ˜¯å‡¶æ‰‹"}</span>
          </div>
        `;
        judgeRecordEl.appendChild(item);
      });

      const canShowRecap = false;
      tabRecapEl.classList.add("hidden");
      recapTitleEl.textContent = "";
      recapTextEl.innerHTML = "";

      endingPanelEl.classList.remove("hidden");
      setEndingTab(state.endingTab, canShowRecap);
    }

    // ===== æ¸¸æˆé¡µæ€»æ¸²æŸ“ =====
    function renderGameScreen() {
      renderGameSidebar();
      renderStage();

      if (allLocked()) {
        const firstTimeEnterEnding = state.phase !== "ended";
        state.phase = "ended";

        if (firstTimeEnterEnding || !state.ending) {
          state.ending = GAME_DATA.evaluateEnding(state);
          unlockEndingAchievement(state.ending.key);

          // æ™®é€šç»“å±€ï¼šç”Ÿæˆæœ¬è½®å›ºå®šä¸»çº¿æç¤º
          state.endingMainHintCache = buildMainlineHintForMixedEnding();
        }

        renderEndingPanel();
      } else {
        endingPanelEl.classList.add("hidden");
      }
    }

    // ===== åˆ¤å®šé€»è¾‘ =====
    function applyJudgment(id, judgedGuilty) {
      if (state.lockedIds.has(id)) return;
      state.judgments[id] = judgedGuilty;
      state.lockedIds.add(id);
      state.selectedId = id;
      state.phase = "reacted";
      renderGameScreen();
    }

    // ===== äº‹ä»¶ç»‘å®š =====
    btnStartGame.addEventListener("click", () => {
      setScreen("game");
      if (!state.ending && state.lockedIds.size === 0 && !state.selectedId && state.phase === "intro" && !state.introVariant) {
        resetGameRun();
      } else if (state.lockedIds.size === 0 && !state.selectedId && !state.ending) {
        if (!state.introVariant) {
          state.introVariant = typeof GAME_DATA.getRandomIntroLine === "function" ? GAME_DATA.getRandomIntroLine() : "";
        }
        renderGameScreen();
      }
    });

    btnGoAchievements.addEventListener("click", () => setScreen("achievements"));
    btnGoBranchHints.addEventListener("click", () => setScreen("branch_hints"));

    btnAchBackStart.addEventListener("click", () => setScreen("start"));
    btnAchReset.addEventListener("click", () => {
      const ok = confirm("ç¡®å®šè¦æ¸…ç©ºå·²è§£é”çš„ç»“å±€æˆå°±è®°å½•å—ï¼Ÿ");
      if (ok) {
        resetAchievements();
        renderAchievementsScreen();
      }
    });

    btnBranchBackStart.addEventListener("click", () => setScreen("start"));

    btnGameBackStart.addEventListener("click", () => setScreen("start"));
    btnRestart.addEventListener("click", resetGameRun);

    tabStageInvestigationEl.addEventListener("click", () => {
      if (state.phase === "ended") return;
      setStageTab("investigation");
    });
    tabStageSceneEl.addEventListener("click", () => {
      if (state.phase === "ended") return;
      setStageTab("scene");
    });

    tabEndingEl.addEventListener("click", () => {
      if (state.phase !== "ended") return;
      setEndingTab("ending");
    });
    tabRecapEl.addEventListener("click", () => {
      if (state.phase !== "ended") return;
      setEndingTab("recap");
    });

    btnRestartFromEnd.addEventListener("click", resetGameRun);
    btnRestartFromRecap.addEventListener("click", resetGameRun);

    btnEndingGoAchievements.addEventListener("click", () => setScreen("achievements"));
    btnRecapGoAchievements.addEventListener("click", () => setScreen("achievements"));

    // ===== åˆå§‹åŒ– =====
    (function init() {
      state.phase = "intro";
      state.selectedId = null;
      state.judgments = {};
      state.lockedIds = new Set();
      state.introVariant = typeof GAME_DATA.getRandomIntroLine === "function"
        ? GAME_DATA.getRandomIntroLine()
        : "";
      state.ending = null;
      state.endingTab = "ending";
      state.stageTab = "investigation";
      state.endingMainHintCache = null;
      state.branchHintSelectedKey = null;
      setScreen("start");
    })();
  </script>
</body>
</html>